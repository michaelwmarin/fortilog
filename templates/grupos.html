{% extends 'base.html' %}
{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col">
        <h2><i class="bi bi-collection"></i> Departamentos e Grupos</h2>
        <p class="text-muted">Gerencie os setores importados do Fortigate (Cores).</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoGrupo">
            <i class="bi bi-plus-lg"></i> Novo Grupo
        </button>
    </div>
</div>

{% if not mapa %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i> Nenhum grupo encontrado. 
    <strong>Dica:</strong> Rode o script <code>import_forti.py</code> para importar as Cores do Fortigate.
</div>
{% endif %}

<div class="row g-3">
    {% for nome_grupo, membros in mapa.items() %}
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 fs-6">{{ nome_grupo }}</h5>
                <span class="badge bg-secondary">{{ membros|length }} membros</span>
            </div>
            <div class="card-body bg-light p-2" style="max-height: 250px; overflow-y: auto;">
                {% if membros %}
                <ul class="list-group list-group-flush small">
                    {% for membro in membros %}
                    <li class="list-group-item bg-transparent d-flex justify-content-between">
                        {{ membro }}
                        <form method="POST" style="display:inline" onsubmit="return confirm('Remover {{ membro }} deste grupo?');">
                            <input type="hidden" name="action" value="del_member">
                            <input type="hidden" name="grupo" value="{{ nome_grupo }}">
                            <input type="hidden" name="membro" value="{{ membro }}">
                            <button class="btn btn-link text-danger p-0 border-0"><i class="bi bi-x-circle"></i></button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center small my-3">Grupo vazio.</p>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <form method="POST" class="input-group input-group-sm">
                    <input type="hidden" name="action" value="add_member">
                    <input type="hidden" name="grupo" value="{{ nome_grupo }}">
                    <input type="text" name="membro" class="form-control" placeholder="Add Nome do UsuÃ¡rio...">
                    <button class="btn btn-outline-secondary"><i class="bi bi-plus"></i></button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="modalNovoGrupo" tabindex="-1">
    <div class="modal-dialog">
        <form method="POST">
            <input type="hidden" name="action" value="add_group">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Criar Novo Grupo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Nome do Grupo/Setor</label>
                    <input type="text" name="grupo" class="form-control" placeholder="Ex: Financeiro" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Criar</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}