{% extends "base.html" %}

{% block content %}
<style>
    .card-dashboard { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); background: #fff; }
    .border-left-blue { border-left: 5px solid #0d6efd; }
    .border-left-green { border-left: 5px solid #198754; }
    .border-left-red { border-left: 5px solid #dc3545; }
    .server-metric-label { font-size: 0.75rem; color: #adb5bd; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; display: block; }
</style>

<div class="container-fluid p-0">
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card card-dashboard border-left-blue p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold">Dispositivos Recentes</h6>
                        <h1 class="display-5 fw-bold text-primary mb-0">{{ total_devices }}</h1>
                    </div>
                    <i class="bi bi-laptop fs-1 text-primary opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-dashboard border-left-green p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold">Tráfego Permitido</h6>
                        <h1 class="display-5 fw-bold text-success mb-0">{{ permitidos }}</h1>
                    </div>
                    <i class="bi bi-shield-check fs-1 text-success opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-dashboard border-left-red p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold">Bloqueios</h6>
                        <h1 class="display-5 fw-bold text-danger mb-0">{{ bloqueados }}</h1>
                    </div>
                    <i class="bi bi-shield-x fs-1 text-danger opacity-25"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-dashboard mb-4">
        <div class="card-header bg-transparent border-bottom pt-4 px-4 pb-3">
            <h6 class="fw-bold m-0"><i class="bi bi-cpu me-2 text-primary"></i>Saúde do Servidor (FortiLog)</h6>
        </div>
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-3 text-center border-end">
                    <span class="server-metric-label">Uso de CPU</span>
                    <div class="position-relative d-inline-block mt-2">
                        <canvas id="cpuChart" width="110" height="110"></canvas>
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <div class="fs-4 fw-bold">{{ stats.cpu }}%</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-9 px-5">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="server-metric-label">Memória RAM</span>
                                <span class="fw-bold small">{{ stats.ram_used }} GB Usados</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-primary" style="width: {{ stats.ram_percent }}%"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="server-metric-label">Espaço em Disco</span>
                                <span class="fw-bold small">{{ stats.disk_percent }}% Ocupado</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-warning" style="width: {{ stats.disk_percent }}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-muted small">
                        <i class="bi bi-database me-1"></i> Tamanho do Banco de Dados: <strong>{{ stats.db_size }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-dashboard">
        <div class="card-header bg-transparent border-bottom pt-4 px-4 pb-3">
            <h6 class="fw-bold m-0"><i class="bi bi-terminal me-2 text-primary"></i>Últimos Eventos Processados</h6>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light small text-uppercase">
                    <tr>
                        <th class="ps-4">Hora</th>
                        <th>Origem</th>
                        <th>Destino</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in sys_logs %}
                    <tr>
                        <td class="ps-4 text-muted small font-monospace">{{ log.hora }}</td>
                        <td><div class="fw-bold">{{ log.src_nome }}</div><div class="small text-muted">{{ log.ip }}</div></td>
                        <td class="text-secondary small">{{ log.destino }}</td>
                        <td><span class="badge rounded-pill {% if log.status_cat == 'Permitido' %}bg-success text-success{% else %}bg-danger text-danger{% endif %} bg-opacity-10 px-3">{{ log.status_cat }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    new Chart(document.getElementById('cpuChart'), {
        type: 'doughnut',
        data: {
            datasets: [{ data: [{{ stats.cpu }}, {{ 100 - stats.cpu }}], backgroundColor: ['#0d6efd', '#f1f3f5'], borderWidth: 0 }]
        },
        options: { cutout: '80%', plugins: { tooltip: { enabled: false } } }
    });
</script>
{% endblock %}