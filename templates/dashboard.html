{% extends "base.html" %}

{% block content %}
<style>
    .card-dashboard {
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        transition: transform 0.2s;
        background: #fff;
    }
    .card-dashboard:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    .border-left-blue { border-left: 5px solid #0d6efd; }
    .border-left-green { border-left: 5px solid #198754; }
    .border-left-red { border-left: 5px solid #dc3545; }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .server-metric-label {
        font-size: 0.85rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
    }
    .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #212529;
    }
</style>

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-0">Visão Geral</h2>
            <p class="text-muted mb-0">Monitoramento em Tempo Real (Histórico 24h)</p>
        </div>
        <div class="bg-white p-2 rounded shadow-sm border d-flex align-items-center">
            <i class="bi bi-pc-display me-2 text-muted"></i>
            <div>
                <small class="d-block text-muted" style="line-height: 1; font-size: 0.7rem;">SERVIDOR</small>
                <span class="fw-bold text-primary">{{ sys_info.hostname }}</span>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card card-dashboard border-left-blue h-100 p-3">
                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Dispositivos Ativos</h6>
                <div class="d-flex align-items-center justify-content-between">
                    <h1 class="display-5 fw-bold text-primary mb-0">{{ total }}</h1>
                    <i class="bi bi-laptop fs-1 text-primary opacity-25"></i>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card card-dashboard border-left-green h-100 p-3">
                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Tráfego Permitido</h6>
                <div class="d-flex align-items-center justify-content-between">
                    <h1 class="display-5 fw-bold text-success mb-0">{{ permitidos }}</h1>
                    <i class="bi bi-shield-check fs-1 text-success opacity-25"></i>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-dashboard border-left-red h-100 p-3">
                <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.8rem;">Bloqueios / Ameaças</h6>
                <div class="d-flex align-items-center justify-content-between">
                    <h1 class="display-5 fw-bold text-danger mb-0">{{ bloqueados }}</h1>
                    <i class="bi bi-shield-x fs-1 text-danger opacity-25"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8 mb-4 mb-lg-0">
            <div class="card card-dashboard h-100">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                    <h6 class="fw-bold">Top Origens (Volume de Dados)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card card-dashboard h-100">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                    <h6 class="fw-bold">Fabricantes Detectados</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div style="height: 250px; width: 100%;">
                        <canvas id="polarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-dashboard mb-4">
        <div class="card-header bg-white border-bottom pt-3">
            <h6 class="fw-bold text-primary"><i class="bi bi-cpu me-2"></i>Monitoramento do Servidor (24 Horas)</h6>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-3 text-center border-end">
                    <p class="server-metric-label mb-1">CPU (Processador)</p>
                    <div class="position-relative d-inline-block">
                        <canvas id="cpuChart" width="100" height="100"></canvas>
                        <div class="position-absolute top-50 start-50 translate-middle fw-bold fs-4">{{ sys_info.cpu }}%</div>
                    </div>
                </div>

                <div class="col-md-5 border-end px-4">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="server-metric-label">Memória RAM</span>
                            <span class="small fw-bold">{{ sys_info.ram_used }} GB Usados</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: {{ sys_info.ram_percent }}%"></div>
                        </div>
                        <small class="text-muted">{{ sys_info.ram_percent }}% ocupado</small>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="server-metric-label">Disco (HD)</span>
                            <span class="small fw-bold">{{ sys_info.disk_percent }}% Ocupado</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ sys_info.disk_percent }}%"></div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 px-4">
                    <p class="server-metric-label mb-3">Rede (Velocidade)</p>
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-light p-2 rounded-circle me-3"><i class="bi bi-arrow-up-short text-warning fs-4"></i></div>
                        <div>
                            <small class="text-muted d-block">Upload</small>
                            <span class="fw-bold fs-5">37.0 KB/s</span> </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="bg-light p-2 rounded-circle me-3"><i class="bi bi-arrow-down-short text-primary fs-4"></i></div>
                        <div>
                            <small class="text-muted d-block">Download</small>
                            <span class="fw-bold fs-5">6.1 KB/s</span>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4">
            <h6 class="server-metric-label mb-3">Histórico de Rede (Últimas 24h)</h6>
            <div style="height: 200px; width: 100%;">
                <canvas id="networkChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. Gráfico de Barras (Top Origens - Simulado com os dados disponíveis ou placeholders para visual)
    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: ['PC-Diretoria', 'SRV-Arquivos', 'iPhone-Visitante', 'Camera-01', 'Recepcao'],
            datasets: [{
                label: 'Permitido',
                data: [12, 19, 3, 5, 2],
                backgroundColor: '#198754'
            },
            {
                label: 'Bloqueado',
                data: [2, 3, 10, 1, 0],
                backgroundColor: '#dc3545'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { stacked: true }, y: { stacked: true } },
            plugins: { legend: { position: 'top' } }
        }
    });

    // 2. Gráfico Polar (Fabricantes) - Dados Reais
    const ctxPolar = document.getElementById('polarChart').getContext('2d');
    new Chart(ctxPolar, {
        type: 'polarArea', // Mudado para Polar Area conforme a foto
        data: {
            labels: {{ labels_fab | safe }},
            datasets: [{
                data: {{ values_fab | safe }},
                backgroundColor: [
                    'rgba(54, 162, 235, 0.7)', // Azul
                    'rgba(255, 99, 132, 0.7)', // Vermelho
                    'rgba(255, 206, 86, 0.7)', // Amarelo
                    'rgba(75, 192, 192, 0.7)', // Verde
                    'rgba(153, 102, 255, 0.7)' // Roxo
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });

    // 3. Gráfico CPU (Donut)
    new Chart(document.getElementById('cpuChart'), {
        type: 'doughnut',
        data: {
            labels: ['Uso', 'Livre'],
            datasets: [{
                data: [{{ sys_info.cpu }}, {{ 100 - sys_info.cpu }}],
                backgroundColor: ['#0d6efd', '#f8f9fa'],
                borderWidth: 0
            }]
        },
        options: { cutout: '85%', plugins: { tooltip: { enabled: false }, legend: { display: false } } }
    });

    // 4. Gráfico de Rede (Linha - Simulação Visual para ficar igual a foto)
    const ctxNet = document.getElementById('networkChart').getContext('2d');
    
    // Gerando dados falsos para a linha parecer "viva" igual na foto
    const labelsNet = Array.from({length: 24}, (_, i) => i + ':00');
    const dataUp = Array.from({length: 24}, () => Math.floor(Math.random() * 50));
    const dataDown = Array.from({length: 24}, () => Math.floor(Math.random() * 100));

    new Chart(ctxNet, {
        type: 'line',
        data: {
            labels: labelsNet,
            datasets: [{
                label: 'Download (KB/s)',
                data: dataDown,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4
            },
            {
                label: 'Upload (KB/s)',
                data: dataUp,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true } }
        }
    });
</script>
{% endblock %}